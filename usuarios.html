<!doctype html>
<html lang="es">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="proyecto" content="Portafolio 2023">
    <title>Usuarios - SAC</title>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/dashboard.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css" />
</head>

<body class="is-preload">

    <div id="nav-component">
    </div>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-body-tertiary sidebar collapse">
                <div class="position-sticky pt-3 sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a id="nombre-usuario" class="nav-link" href="perfil.html">
                                <img id="img-usuario"
                                    src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSK8HJpZl5SDTDZP455OxKbc71lJTRXW4wygA&usqp=CAU"
                                    alt="" width="32" height="32" class="rounded-circle me-2">
                            </a>
                        </li>
                        <hr />
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="dashboard.html">
                                <span data-feather="home" class="align-text-bottom"></span>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="informes.html">
                                <span data-feather="bar-chart-2" class="align-text-bottom"></span>
                                Indicadores
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="usuarios.html">
                                <span data-feather="users" class="align-text-bottom"></span>
                                Usuarios
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="alimentacion.html">
                                <span data-feather="coffee" class="align-text-bottom"></span>
                                Alimentación
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="asistencia.html">
                                <span data-feather="calendar" class="align-text-bottom"></span>
                                Asistencia
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="permisos.html">
                                <span data-feather="sun" class="align-text-bottom"></span>
                                Permisos
                            </a>
                        </li>

                    </ul>
                    <hr />

                    <h6
                        class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-body-secondary text-uppercase">
                        <span>Favoritos</span>
                        <span data-feather="star" class="align-text-bottom"></span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a download="sacApk" class="nav-link" href="\assets\sacApk.apk">
                                <span data-feather="smartphone" class="align-text-bottom"></span>
                                Descarga la APP
                            </a>
                            </li>
                                <li class="nav-item">
                                    <a download="Manual SAC" class="nav-link" href="\assets\sacManual.pdf">
                                    <span data-feather="file" class="align-text-bottom"></span>
                                Descarga el manual
                            </a>
                            </li>   
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="faq.html">
                                <span data-feather="help-circle" class="align-text-bottom"></span>
                                Preguntas Frecuentes
                            </a>
                        </li>

                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Gestión de Usuarios</h1>
                        
                </div>
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-2 pb-3">
                    <a class="btn btn-warning" href="agregar_usuario.html" role="button">Agregar Usuario</a>
                </div>
                

                <div class="table-responsive">
                    <table id="example" class="display" style="width:100%" class="display table table-striped table-sm">
                       
                    </table>
                </div>
            </main>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>


    <script src="assets/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"
        integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE"
        crossorigin="anonymous"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"
        integrity="sha384-gdQErvCNWvHQZj6XZM0dNsAoY4v+j5P1XDpNkcM3HJG1Yx04ecqIHk7+4VBOCHOG"
        crossorigin="anonymous"></script> -->
    <script src="assets\js\usuarios.js"></script>
    <script src="assets/js/componentImport.js"></script>
    <script>

        function editarUsuario(button) {
        
        const id = button.getAttribute("data-id");
        if (id) {
            window.location.href = `editar_usuario.html?id=${id}`;
            localStorage.setItem('idUser', id )
        } else {
            console.error('ID de usuario no válido');
        }
        }

        function borrar(button) {
            // Obtén el ID del usuario desde el atributo data-id del botón
            const id = button.getAttribute("data-id");

            // Muestra la ventana emergente con Swal
            Swal.fire({
                title: "¿Estás seguro?",
                text: "¿Quieres desactivar este usuario?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, desactivar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                const id_estado = 2;

                // Realiza una solicitud para actualizar el estado del usuario
                $.ajax({
                    url: `http://localhost:3000/api/v1/usuarios/estado/${id}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ id_estado }),
                    success: function (response) {
          // La solicitud se ha completado correctamente
                        Swal.fire({
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Usuario desactivado exitosamente'
                        }).then(function () {
                            // Redirecciona a la página de usuarios después de cerrar el cuadro de diálogo
                            window.location.href = 'usuarios.html';
                        });
                        },
                    error: function (xhr, status, error) {
                    console.log('Error al actualizar el estado de usuario');
                    }
                });
                }
            });
            }



        $(document).ready(function () {
            var tabla_usuario = $('#example').DataTable({
                "language": { "url": "//cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json" },
                columns: [
                    { "title": "Usuario", "data": "usuario" },
                    { "title": "Rol", "data": "rol" },
                    { "title": "Correo", "data": "correo" },
                    { "title": "Creado", "data": "fecha_creacion" },
                    { "title": "Acciones", "render": function (data, type, row) { return "<button class='btnEditar btn btn-sm btn-outline-primary' type='button' data-id='" + row.id + "' onclick='editarUsuario(this)'>Editar</button>&nbsp;&nbsp;<button class='btnBorrar btn btn-sm btn-outline-danger' type='button' data-id='" + row.id + "' onclick='borrar(this)'>Borrar</button>"; } }

                ]
            });
            GetUsuarios();

            // Obtener lista de Usuarios por Empresa y que sean distintos al usuario que consulta
            function GetUsuarios() {
                const id_empresa = localStorage.getItem('id_empresa');
                const id_usuario = localStorage.getItem('id_usuario');
                return $.ajax({
                    url: 'http://localhost:3000/api/v1/usuarios/'+id_usuario + '/' + id_empresa,
                    type: 'GET',
                    success: function (response) {
                        const res = response;
                        const usuario = res.data;
                        usuario.forEach(fila => {
                            console.log('ID de usuario:', fila.id);
                            
                            tabla_usuario.row.add({
                                "id": fila.id,
                                "usuario": fila.usuario,
                                "rol": fila.rol,
                                "correo": fila.correo,
                                "fecha_creacion": fila.fecha_creacion
                            }).draw();
                            
                            
                        });
                    }
                });
            }
        });

       
    </script>
</body>

</html>